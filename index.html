<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="QuestLife">
  <meta name="theme-color" content="#1a1a1a">
  <title>QuestLife - Gamify Your Reality</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-color: #1a1a1a;
      --main-darker: #0d0d0d;
      --main-lighter: #2a2a2a;
      --accent-color: #00ff88;
      --accent-glow: rgba(0, 255, 136, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #888888;
      --text-muted: #555555;
      --danger: #ff4757;
      --warning: #ffa502;
      --xp-bar: linear-gradient(90deg, var(--accent-color), #00ffcc);
      --card-bg: rgba(30, 30, 30, 0.8);
      --border-color: rgba(255, 255, 255, 0.1);
      --safe-top: env(safe-area-inset-top, 20px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Exo 2', sans-serif; background: var(--main-color); color: var(--text-primary); min-height: 100vh; }
    #root { height: 100%; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--main-darker); }
    ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 2px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes questComplete { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }
    .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    .quest-complete-anim { animation: questComplete 0.4s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // Hooks
    const useLocalStorage = (key, initialValue) => {
      const [storedValue, setStoredValue] = useState(() => {
        try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } 
        catch { return initialValue; }
      });
      const setValue = (value) => {
        const valueToStore = value instanceof Function ? value(storedValue) : value;
        setStoredValue(valueToStore);
        window.localStorage.setItem(key, JSON.stringify(valueToStore));
      };
      return [storedValue, setValue];
    };

    // Utils
    const formatDate = (date) => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    const formatTime = (time) => { if (!time) return ''; const [h, m] = time.split(':'); const hour = parseInt(h); return `${hour % 12 || 12}:${m} ${hour >= 12 ? 'PM' : 'AM'}`; };
    const isSameDay = (d1, d2) => new Date(d1).toDateString() === new Date(d2).toDateString();
    const generateId = () => Math.random().toString(36).substr(2, 9);
    const adjustColor = (hex, amt) => { const num = parseInt(hex.replace('#', ''), 16); const r = Math.max(0, Math.min(255, (num >> 16) + amt)); const g = Math.max(0, Math.min(255, ((num >> 8) & 0xFF) + amt)); const b = Math.max(0, Math.min(255, (num & 0xFF) + amt)); return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`; };
    const calculateLevel = (xp) => { let level = 1, xpNeeded = 100, total = 0; while (xp >= total + xpNeeded) { total += xpNeeded; level++; xpNeeded = Math.floor(100 * Math.pow(1.2, level - 1)); } return { level, currentXp: xp - total, xpNeeded, totalXp: xp }; };
    const requestNotificationPermission = async () => { if ('Notification' in window) return (await Notification.requestPermission()) === 'granted'; return false; };
    const scheduleNotification = (title, body, time) => { if ('Notification' in window && Notification.permission === 'granted') { const delay = new Date(time) - new Date(); if (delay > 0) setTimeout(() => new Notification(title, { body }), delay); } };

    // Icons
    const Icons = {
      Calendar: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
      Quest: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
      Trophy: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
      Settings: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>,
      AI: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>,
      Plus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      Check: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
      Clock: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Repeat: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>,
      Bell: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
      Trash: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
      ChevronLeft: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>,
      ChevronRight: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
      Send: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
      Flame: () => <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 23c-3.87 0-7-3.36-7-7.5 0-2.21.9-4.17 2.33-5.63a3.5 3.5 0 0 1 5.08 0c.28.29.71.29 1 0 1.15-1.17 1.9-2.76 2-4.5v-.75a.75.75 0 0 1 1.5 0v.75c0 .41.05.82.14 1.21C18.5 10 20 12.5 20 15.5c0 4.14-3.13 7.5-7 7.5z"/></svg>,
    };

    // Theme presets
    const themePresets = {
      default: { main: '#1a1a1a', accent: '#00ff88', name: 'Cyber Green' },
      blue: { main: '#0f1729', accent: '#00d4ff', name: 'Neon Blue' },
      purple: { main: '#1a0f29', accent: '#bf5fff', name: 'Royal Purple' },
      red: { main: '#1f0f0f', accent: '#ff4757', name: 'Crimson' },
      gold: { main: '#1a1507', accent: '#ffd700', name: 'Golden Age' },
      pink: { main: '#1f0f1a', accent: '#ff6b9d', name: 'Sakura' },
      orange: { main: '#1a120a', accent: '#ff9f43', name: 'Sunset' },
      teal: { main: '#0a1a1a', accent: '#20e3b2', name: 'Ocean' }
    };

    // Header
    const Header = ({ stats, theme }) => {
      const levelInfo = calculateLevel(stats.totalXp);
      const xpProgress = (levelInfo.currentXp / levelInfo.xpNeeded) * 100;
      return (
        <div style={{ paddingTop: 'calc(var(--safe-top) + 10px)', padding: 'calc(var(--safe-top) + 10px) 20px 15px', background: 'linear-gradient(180deg, var(--main-darker) 0%, transparent 100%)', position: 'sticky', top: 0, zIndex: 100 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
            <h1 style={{ fontFamily: 'Orbitron, sans-serif', fontSize: '22px', fontWeight: 700, background: `linear-gradient(135deg, var(--accent-color), ${theme.accent}dd)`, WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', letterSpacing: '2px' }}>QUESTLIFE</h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '4px', color: '#ffa502' }}>
                <span style={{ width: '16px', height: '16px' }}><Icons.Flame /></span>
                <span style={{ fontFamily: 'Orbitron', fontWeight: 600, fontSize: '13px' }}>{stats.streak}</span>
              </div>
              <div style={{ background: 'var(--card-bg)', padding: '6px 12px', borderRadius: '16px', border: '1px solid var(--border-color)', fontFamily: 'Orbitron', fontSize: '11px' }}>
                <span style={{ color: 'var(--accent-color)' }}>LVL {levelInfo.level}</span>
              </div>
            </div>
          </div>
          <div style={{ background: 'var(--main-darker)', borderRadius: '8px', height: '6px', overflow: 'hidden' }}>
            <div style={{ height: '100%', width: `${xpProgress}%`, background: 'var(--xp-bar)', borderRadius: '8px', transition: 'width 0.5s', boxShadow: '0 0 8px var(--accent-glow)' }} />
          </div>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '4px', fontSize: '10px', color: 'var(--text-secondary)', fontFamily: 'JetBrains Mono' }}>
            <span>{levelInfo.currentXp} XP</span>
            <span>{levelInfo.xpNeeded} XP to Level {levelInfo.level + 1}</span>
          </div>
        </div>
      );
    };

    // Navigation
    const Navigation = ({ activeTab, setActiveTab }) => {
      const tabs = [
        { id: 'quests', icon: Icons.Quest, label: 'Quests' },
        { id: 'calendar', icon: Icons.Calendar, label: 'Calendar' },
        { id: 'rewards', icon: Icons.Trophy, label: 'Rewards' },
        { id: 'ai', icon: Icons.AI, label: 'AI' },
        { id: 'settings', icon: Icons.Settings, label: 'Settings' }
      ];
      return (
        <nav style={{ position: 'fixed', bottom: 0, left: 0, right: 0, background: 'var(--main-darker)', borderTop: '1px solid var(--border-color)', paddingBottom: 'var(--safe-bottom)', zIndex: 1000 }}>
          <div style={{ display: 'flex', justifyContent: 'space-around', padding: '8px 5px' }}>
            {tabs.map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{ background: 'none', border: 'none', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '3px', color: activeTab === tab.id ? 'var(--accent-color)' : 'var(--text-secondary)', cursor: 'pointer', padding: '5px 12px' }}>
                <span style={{ width: '22px', height: '22px', filter: activeTab === tab.id ? 'drop-shadow(0 0 4px var(--accent-color))' : 'none' }}><tab.icon /></span>
                <span style={{ fontSize: '9px', fontWeight: activeTab === tab.id ? 600 : 400 }}>{tab.label}</span>
              </button>
            ))}
          </div>
        </nav>
      );
    };

    // Quest Card
    const QuestCard = ({ quest, onComplete, onDelete }) => {
      const [completing, setCompleting] = useState(false);
      const handleComplete = () => { setCompleting(true); setTimeout(() => { onComplete(quest.id); setCompleting(false); }, 400); };
      const difficultyColors = { easy: '#00ff88', medium: '#ffa502', hard: '#ff4757', epic: '#bf5fff' };
      const difficultyXp = { easy: 10, medium: 25, hard: 50, epic: 100 };
      return (
        <div className={completing ? 'quest-complete-anim' : ''} style={{ background: quest.completed ? 'linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,255,136,0.05))' : 'var(--card-bg)', borderRadius: '12px', padding: '14px', marginBottom: '10px', border: `1px solid ${quest.completed ? 'var(--accent-color)' : 'var(--border-color)'}`, opacity: quest.completed ? 0.7 : 1, position: 'relative', overflow: 'hidden' }}>
          <div style={{ position: 'absolute', top: 0, left: 0, width: '4px', height: '100%', background: difficultyColors[quest.difficulty] }} />
          <div style={{ display: 'flex', alignItems: 'flex-start', gap: '10px', paddingLeft: '8px' }}>
            <button onClick={handleComplete} disabled={quest.completed} style={{ width: '26px', height: '26px', borderRadius: '7px', border: `2px solid ${quest.completed ? 'var(--accent-color)' : 'var(--text-secondary)'}`, background: quest.completed ? 'var(--accent-color)' : 'transparent', cursor: quest.completed ? 'default' : 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: quest.completed ? 'var(--main-color)' : 'transparent', flexShrink: 0 }}>
              {quest.completed && <span style={{ width: '14px', height: '14px' }}><Icons.Check /></span>}
            </button>
            <div style={{ flex: 1, minWidth: 0 }}>
              <h3 style={{ fontSize: '15px', fontWeight: 600, marginBottom: '3px', textDecoration: quest.completed ? 'line-through' : 'none', color: quest.completed ? 'var(--text-secondary)' : 'var(--text-primary)' }}>{quest.title}</h3>
              {quest.description && <p style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '6px' }}>{quest.description}</p>}
              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', alignItems: 'center' }}>
                <span style={{ background: 'rgba(0,255,136,0.15)', color: 'var(--accent-color)', padding: '2px 7px', borderRadius: '10px', fontSize: '10px', fontFamily: 'Orbitron', fontWeight: 600 }}>+{difficultyXp[quest.difficulty]} XP</span>
                {quest.isRecurring && <span style={{ display: 'flex', alignItems: 'center', gap: '3px', color: 'var(--text-secondary)', fontSize: '10px' }}><span style={{ width: '11px', height: '11px' }}><Icons.Repeat /></span>Recurring</span>}
                {quest.time && <span style={{ display: 'flex', alignItems: 'center', gap: '3px', color: 'var(--text-secondary)', fontSize: '10px' }}><span style={{ width: '11px', height: '11px' }}><Icons.Clock /></span>{formatTime(quest.time)}</span>}
                {quest.notify && <span style={{ color: '#ffa502', fontSize: '10px' }}><span style={{ width: '11px', height: '11px', display: 'inline-block' }}><Icons.Bell /></span></span>}
              </div>
            </div>
            <button onClick={() => onDelete(quest.id)} style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', padding: '4px', opacity: 0.5 }}>
              <span style={{ width: '16px', height: '16px', display: 'block' }}><Icons.Trash /></span>
            </button>
          </div>
        </div>
      );
    };

    // Add Quest Modal
    const AddQuestModal = ({ isOpen, onClose, onAdd, selectedDate }) => {
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [difficulty, setDifficulty] = useState('medium');
      const [time, setTime] = useState('');
      const [notify, setNotify] = useState(false);
      const [isRecurring, setIsRecurring] = useState(false);
      const [recurringDays, setRecurringDays] = useState([]);
      const [targetDate, setTargetDate] = useState(selectedDate || new Date().toISOString().split('T')[0]);
      useEffect(() => { if (selectedDate) setTargetDate(selectedDate); }, [selectedDate]);

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!title.trim()) return;
        const quest = { id: generateId(), title: title.trim(), description: description.trim(), difficulty, time: time || null, notify, isRecurring, recurringDays: isRecurring ? recurringDays : [], date: targetDate, completed: false, createdAt: new Date().toISOString() };
        onAdd(quest);
        if (notify && time) scheduleNotification(`Quest: ${title}`, description || 'Time to complete your quest!', new Date(`${targetDate}T${time}`));
        setTitle(''); setDescription(''); setDifficulty('medium'); setTime(''); setNotify(false); setIsRecurring(false); setRecurringDays([]);
        onClose();
      };

      const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      if (!isOpen) return null;

      return (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'flex-end', zIndex: 2000 }} onClick={onClose}>
          <div className="animate-in" style={{ background: 'var(--main-color)', width: '100%', maxHeight: '85vh', borderRadius: '20px 20px 0 0', padding: '20px', paddingBottom: 'calc(20px + var(--safe-bottom))', overflowY: 'auto' }} onClick={e => e.stopPropagation()}>
            <div style={{ width: '40px', height: '4px', background: 'var(--text-muted)', borderRadius: '2px', margin: '0 auto 16px' }} />
            <h2 style={{ fontFamily: 'Orbitron', fontSize: '18px', marginBottom: '18px', textAlign: 'center' }}>NEW QUEST</h2>
            <form onSubmit={handleSubmit}>
              <div style={{ marginBottom: '14px' }}>
                <label style={{ fontSize: '11px', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px' }}>Quest Title *</label>
                <input type="text" value={title} onChange={e => setTitle(e.target.value)} placeholder="Enter quest name..." style={{ width: '100%', background: 'var(--main-darker)', border: '1px solid var(--border-color)', borderRadius: '10px', padding: '11px 14px', color: 'var(--text-primary)', fontSize: '15px', fontFamily: 'Exo 2' }} autoFocus />
              </div>
              <div style={{ marginBottom: '14px' }}>
                <label style={{ fontSize: '11px', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px' }}>Description</label>
                <textarea value={description} onChange={e => setDescription(e.target.value)} placeholder="Quest details..." rows={2} style={{ width: '100%', background: 'var(--main-darker)', border: '1px solid var(--border-color)', borderRadius: '10px', padding: '11px 14px', color: 'var(--text-primary)', fontSize: '13px', fontFamily: 'Exo 2', resize: 'none' }} />
              </div>
              <div style={{ marginBottom: '14px' }}>
                <label style={{ fontSize: '11px', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px' }}>Date</label>
                <input type="date" value={targetDate} onChange={e => setTargetDate(e.target.value)} style={{ width: '100%', background: 'var(--main-darker)', border: '1px solid var(--border-color)', borderRadius: '10px', padding: '11px 14px', color: 'var(--text-primary)', fontSize: '15px' }} />
              </div>
              <div style={{ marginBottom: '14px' }}>
                <label style={{ fontSize: '11px', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px' }}>Difficulty</label>
                <div style={{ display: 'flex', gap: '8px' }}>
                  {['easy', 'medium', 'hard', 'epic'].map(d => (
                    <button key={d} type="button" onClick={() => setDifficulty(d)} style={{ flex: 1, padding: '9px', borderRadius: '8px', border: difficulty === d ? '2px solid var(--accent-color)' : '1px solid var(--border-color)', background: difficulty === d ? 'rgba(0,255,136,0.1)' : 'var(--main-darker)', color: difficulty === d ? 'var(--accent-color)' : 'var(--text-secondary)', fontSize: '11px', fontWeight: 600, textTransform: 'capitalize', cursor: 'pointer' }}>{d}</button>
                  ))}
                </div>
              </div>
              <div style={{ marginBottom: '14px' }}>
                <label style={{ fontSize: '11px', color: 'var(--text-secondary)', display: 'block', marginBottom: '4px' }}>Time (optional)</label>
                <input type="time" value={time} onChange={e => setTime(e.target.value)} style={{ width: '100%', background: 'var(--main-darker)', border: '1px solid var(--border-color)', borderRadius: '10px', padding: '11px 14px', color: 'var(--text-primary)', fontSize: '15px' }} />
              </div>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '14px', padding: '11px 14px', background: 'var(--main-darker)', borderRadius: '10px' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ width: '18px', height: '18px', color: 'var(--text-secondary)' }}><Icons.Bell /></span>
                  <span style={{ fontSize: '13px' }}>Notification</span>
                </div>
                <button type="button" onClick={() => { if (!notify) requestNotificationPermission(); setNotify(!notify); }} style={{ width: '46px', height: '26px', borderRadius: '13px', border: 'none', background: notify ? 'var(--accent-color)' : 'var(--text-muted)', cursor: 'pointer', position: 'relative' }}>
                  <div style={{ width: '20px', height: '20px', borderRadius: '50%', background: 'white', position: 'absolute', top: '3px', left: notify ? '23px' : '3px', transition: 'left 0.2s' }} />
                </button>
              </div>
              <div style={{ marginBottom: '14px', padding: '11px 14px', background: 'var(--main-darker)', borderRadius: '10px' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: isRecurring ? '12px' : 0 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ width: '18px', height: '18px', color: 'var(--text-secondary)' }}><Icons.Repeat /></span>
                    <span style={{ fontSize: '13px' }}>Recurring</span>
                  </div>
                  <button type="button" onClick={() => setIsRecurring(!isRecurring)} style={{ width: '46px', height: '26px', borderRadius: '13px', border: 'none', background: isRecurring ? 'var(--accent-color)' : 'var(--text-muted)', cursor: 'pointer', position: 'relative' }}>
                    <div style={{ width: '20px', height: '20px', borderRadius: '50%', background: 'white', position: 'absolute', top: '3px', left: isRecurring ? '23px' : '3px', transition: 'left 0.2s' }} />
                  </button>
                </div>
                {isRecurring && (
                  <div style={{ display: 'flex', gap: '4px' }}>
                    {dayNames.map((day, i) => (
                      <button key={i} type="button" onClick={() => setRecurringDays(prev => prev.includes(i) ? prev.filter(d => d !== i) : [...prev, i])} style={{ flex: 1, padding: '7px 4px', borderRadius: '6px', border: recurringDays.includes(i) ? '1px solid var(--accent-color)' : '1px solid var(--border-color)', background: recurringDays.includes(i) ? 'rgba(0,255,136,0.2)' : 'transparent', color: recurringDays.includes(i) ? 'var(--accent-color)' : 'var(--text-secondary)', fontSize: '10px', cursor: 'pointer' }}>{day}</button>
                    ))}
                  </div>
                )}
              </div>
              <button type="submit" style={{ width: '100%', padding: '14px', borderRadius: '12px', border: 'none', background: 'var(--accent-color)', color: 'var(--main-color)', fontSize: '15px', fontFamily: 'Orbitron', fontWeight: 700, cursor: 'pointer', boxShadow: '0 0 15px var(--accent-glow)' }}>CREATE QUEST</button>
            </form>
          </div>
        </div>
      );
    };

    // Quests Tab
    const QuestsTab = ({ quests, setQuests, stats, setStats, theme }) => {
      const [showAddModal, setShowAddModal] = useState(false);
      const today = new Date().toISOString().split('T')[0];
      const todayQuests = useMemo(() => {
        const dow = new Date(today).getDay();
        return quests.filter(q => isSameDay(q.date, today) || (q.isRecurring && q.recurringDays.includes(dow)));
      }, [quests, today]);

      const handleComplete = (questId) => {
        const quest = quests.find(q => q.id === questId);
        if (!quest || quest.completed) return;
        const xpReward = { easy: 10, medium: 25, hard: 50, epic: 100 }[quest.difficulty];
        setQuests(prev => prev.map(q => q.id === questId ? { ...q, completed: true, completedAt: new Date().toISOString() } : q));
        setStats(prev => ({ ...prev, totalXp: prev.totalXp + xpReward, questsCompleted: prev.questsCompleted + 1, todayXp: prev.todayXp + xpReward }));
      };

      const pendingQuests = todayQuests.filter(q => !q.completed);
      const completedQuests = todayQuests.filter(q => q.completed);

      return (
        <div style={{ padding: '16px', paddingBottom: '90px' }}>
          <div style={{ background: 'var(--card-bg)', borderRadius: '14px', padding: '16px', marginBottom: '16px', border: '1px solid var(--border-color)' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
              <span style={{ color: 'var(--text-secondary)', fontSize: '12px' }}>Today's Progress</span>
              <span style={{ color: 'var(--accent-color)', fontFamily: 'Orbitron', fontSize: '13px' }}>{completedQuests.length}/{todayQuests.length}</span>
            </div>
            <div style={{ background: 'var(--main-darker)', borderRadius: '6px', height: '8px', overflow: 'hidden' }}>
              <div style={{ height: '100%', width: todayQuests.length > 0 ? `${(completedQuests.length / todayQuests.length) * 100}%` : '0%', background: 'var(--xp-bar)', borderRadius: '6px' }} />
            </div>
          </div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
            <h2 style={{ fontFamily: 'Orbitron', fontSize: '12px', color: 'var(--text-secondary)', letterSpacing: '2px' }}>{formatDate(today).toUpperCase()}</h2>
            <button onClick={() => setShowAddModal(true)} style={{ background: 'var(--accent-color)', border: 'none', borderRadius: '10px', padding: '9px 14px', color: 'var(--main-color)', fontWeight: 600, fontSize: '12px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '4px', boxShadow: '0 0 12px var(--accent-glow)' }}>
              <span style={{ width: '14px', height: '14px' }}><Icons.Plus /></span>New Quest
            </button>
          </div>
          {pendingQuests.length === 0 && completedQuests.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '36px 16px', color: 'var(--text-secondary)' }}>
              <div style={{ width: '50px', height: '50px', margin: '0 auto 12px', opacity: 0.3 }}><Icons.Quest /></div>
              <p style={{ fontSize: '15px', marginBottom: '4px' }}>No quests for today</p>
              <p style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Create your first quest!</p>
            </div>
          ) : (
            <>
              {pendingQuests.map(quest => <QuestCard key={quest.id} quest={quest} onComplete={handleComplete} onDelete={(id) => setQuests(prev => prev.filter(q => q.id !== id))} />)}
              {completedQuests.length > 0 && (
                <>
                  <div style={{ fontSize: '11px', color: 'var(--text-muted)', margin: '16px 0 8px', display: 'flex', alignItems: 'center', gap: '8px' }}><span>COMPLETED</span><div style={{ flex: 1, height: '1px', background: 'var(--border-color)' }} /></div>
                  {completedQuests.map(quest => <QuestCard key={quest.id} quest={quest} onComplete={handleComplete} onDelete={(id) => setQuests(prev => prev.filter(q => q.id !== id))} />)}
                </>
              )}
            </>
          )}
          <AddQuestModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onAdd={(quest) => setQuests(prev => [...prev, quest])} selectedDate={today} />
        </div>
      );
    };

    // Calendar Tab
    const CalendarTab = ({ quests, setQuests, events, setEvents }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(null);
      const [showAddModal, setShowAddModal] = useState(false);
      const [showEventModal, setShowEventModal] = useState(false);
      const [newEvent, setNewEvent] = useState({ title: '', time: '' });
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      const getDaysInMonth = (date) => {
        const year = date.getFullYear(), month = date.getMonth();
        const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
        const days = [];
        for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
        for (let i = 1; i <= lastDay.getDate(); i++) days.push(new Date(year, month, i));
        return days;
      };

      const days = getDaysInMonth(currentDate);
      const today = new Date();
      const getQuestsForDate = (date) => { if (!date) return []; const ds = date.toISOString().split('T')[0]; const dow = date.getDay(); return quests.filter(q => isSameDay(q.date, ds) || (q.isRecurring && q.recurringDays.includes(dow))); };
      const getEventsForDate = (date) => { if (!date) return []; return events.filter(e => isSameDay(e.date, date.toISOString().split('T')[0])); };
      const selectedDateQuests = selectedDate ? getQuestsForDate(new Date(selectedDate)) : [];
      const selectedDateEvents = selectedDate ? getEventsForDate(new Date(selectedDate)) : [];

      const handleAddEvent = () => {
        if (!newEvent.title.trim()) return;
        const event = { id: generateId(), ...newEvent, date: selectedDate };
        setEvents(prev => [...prev, event]);
        if (newEvent.time) scheduleNotification(`Event: ${newEvent.title}`, 'Upcoming event!', new Date(`${selectedDate}T${newEvent.time}`));
        setNewEvent({ title: '', time: '' });
        setShowEventModal(false);
      };

      return (
        <div style={{ padding: '16px', paddingBottom: '90px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} style={{ background: 'var(--card-bg)', border: '1px solid var(--border-color)', borderRadius: '8px', padding: '8px', color: 'var(--text-primary)', cursor: 'pointer' }}>
              <span style={{ width: '18px', height: '18px', display: 'block' }}><Icons.ChevronLeft /></span>
            </button>
            <h2 style={{ fontFamily: 'Orbitron', fontSize: '16px' }}>{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} style={{ background: 'var(--card-bg)', border: '1px solid var(--border-color)', borderRadius: '8px', padding: '8px', color: 'var(--text-primary)', cursor: 'pointer' }}>
              <span style={{ width: '18px', height: '18px', display: 'block' }}><Icons.ChevronRight /></span>
            </button>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px', marginBottom: '8px' }}>
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => <div key={i} style={{ textAlign: 'center', fontSize: '11px', color: 'var(--text-secondary)', fontWeight: 600, padding: '4px' }}>{d}</div>)}
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' }}>
            {days.map((day, i) => {
              if (!day) return <div key={i} />;
              const ds = day.toISOString().split('T')[0];
              const dq = getQuestsForDate(day);
              const de = getEventsForDate(day);
              const isToday = isSameDay(day, today);
              const isSelected = selectedDate === ds;
              const hasItems = dq.length > 0 || de.length > 0;
              return (
                <button key={i} onClick={() => setSelectedDate(ds)} style={{ aspectRatio: '1', background: isSelected ? 'var(--accent-color)' : isToday ? 'rgba(0,255,136,0.2)' : 'var(--card-bg)', border: isToday ? '2px solid var(--accent-color)' : '1px solid var(--border-color)', borderRadius: '8px', color: isSelected ? 'var(--main-color)' : 'var(--text-primary)', fontWeight: isToday ? 700 : 400, fontSize: '13px', cursor: 'pointer', position: 'relative', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
                  {day.getDate()}
                  {hasItems && <div style={{ position: 'absolute', bottom: '3px', display: 'flex', gap: '2px' }}>{dq.length > 0 && <div style={{ width: '4px', height: '4px', borderRadius: '50%', background: isSelected ? 'var(--main-color)' : 'var(--accent-color)' }} />}{de.length > 0 && <div style={{ width: '4px', height: '4px', borderRadius: '50%', background: isSelected ? 'var(--main-color)' : '#ffa502' }} />}</div>}
                </button>
              );
            })}
          </div>
          {selectedDate && (
            <div style={{ marginTop: '16px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                <h3 style={{ fontFamily: 'Orbitron', fontSize: '12px', color: 'var(--text-secondary)' }}>{formatDate(selectedDate).toUpperCase()}</h3>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button onClick={() => setShowAddModal(true)} style={{ background: 'var(--accent-color)', border: 'none', borderRadius: '6px', padding: '6px 10px', color: 'var(--main-color)', fontWeight: 600, fontSize: '11px', cursor: 'pointer' }}>+ Quest</button>
                  <button onClick={() => setShowEventModal(true)} style={{ background: '#ffa502', border: 'none', borderRadius: '6px', padding: '6px 10px', color: 'var(--main-color)', fontWeight: 600, fontSize: '11px', cursor: 'pointer' }}>+ Event</button>
                </div>
              </div>
              {selectedDateQuests.length === 0 && selectedDateEvents.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '24px', color: 'var(--text-secondary)', background: 'var(--card-bg)', borderRadius: '10px', border: '1px solid var(--border-color)' }}><p style={{ fontSize: '13px' }}>No items scheduled</p></div>
              ) : (
                <>
                  {selectedDateEvents.map(event => (
                    <div key={event.id} style={{ background: 'var(--card-bg)', borderRadius: '10px', padding: '12px', marginBottom: '8px', border: '1px solid var(--border-color)', borderLeft: '4px solid #ffa502' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div>
                          <h4 style={{ fontSize: '14px', marginBottom: '3px' }}>{event.title}</h4>
                          {event.time && <span style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>{formatTime(event.time)}</span>}
                        </div>
                        <button onClick={() => setEvents(prev => prev.filter(e => e.id !== event.id))} style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', padding: '3px' }}>
                          <span style={{ width: '14px', height: '14px', display: 'block' }}><Icons.Trash /></span>
                        </button>
                      </div>
                    </div>
                  ))}
                  {selectedDateQuests.map(quest => <QuestCard key={quest.id} quest={quest} onComplete={() => {}} onDelete={(id) => setQuests(prev => prev.filter(q => q.id !== id))} />)}
                </>
              )}
            </div>
          )}
          <AddQuestModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onAdd={(quest) => setQuests(prev => [...prev, quest])} selectedDate={selectedDate} />
          {showEventModal && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'flex-end', zIndex: 2000 }} onClick={() => setShowEventModal(false)}>
              <div className="animate-in" style={{ background: 'var(--main-color)', width: '100%', borderRadius: '20px 20px 0 0', padding: '20px', paddingBottom: 'calc(20px + var(--safe-bottom))' }} onClick={e => e.stopPropagation()}>
                <div style={{ width: '40px', height: '4px', background: 'var(--text-muted)', borderRadius: '2px', margin: '0 auto 16px' }} />
                <h2 style={{ fontFamily: 'Orbitron', fontSize: '18px', marginBottom: '18px', textAlign: 'center' }}>NEW EVENT</h2>
                <input type="text" placeholder="Event title" value={newEvent.title} onChange={e => setNewEvent(prev => ({ ...prev, title: e.target.value }))} style={{ width: '100%', background: 'var(--main-darker)', border: '1px solid var(--border-color)', borderRadius: '10px', padding: '11px 14px', color: 'var(--text-primary)', fontSize: '15px', marginBottom: '12px' }} autoFocus />
                <input type="time" value={newEvent.time} onChange={e => setNewEvent(prev => ({ ...prev, time: e.target.value }))} style={{ width: '100%', background: 'var(--main-darker)', border: '1px solid var(--border-color)', borderRadius: '10px', padding: '11px 14px', color: 'var(--text-primary)', fontSize: '15px', marginBottom: '12px' }} />
                <button onClick={handleAddEvent} style={{ width: '100%', padding: '14px', borderRadius: '12px', border: 'none', background: '#ffa502', color: 'var(--main-color)', fontSize: '15px', fontFamily: 'Orbitron', fontWeight: 700, cursor: 'pointer' }}>CREATE EVENT</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Rewards Tab
    const RewardsTab = ({ stats }) => {
      const levelInfo = calculateLevel(stats.totalXp);
      const achievements = [
        { id: 'first', name: 'First Steps', desc: 'Complete first quest', icon: 'âš”ï¸', unlocked: stats.questsCompleted >= 1 },
        { id: 'ten', name: 'Adventurer', desc: 'Complete 10 quests', icon: 'ðŸ†', unlocked: stats.questsCompleted >= 10 },
        { id: 'fifty', name: 'Hero', desc: 'Complete 50 quests', icon: 'ðŸ‘‘', unlocked: stats.questsCompleted >= 50 },
        { id: 'hundred', name: 'Legend', desc: 'Complete 100 quests', icon: 'ðŸŒŸ', unlocked: stats.questsCompleted >= 100 },
        { id: 'week', name: 'Consistent', desc: '7 day streak', icon: 'ðŸ”¥', unlocked: stats.streak >= 7 },
        { id: 'month', name: 'Dedicated', desc: '30 day streak', icon: 'ðŸ’Ž', unlocked: stats.streak >= 30 },
        { id: 'lvl5', name: 'Rising Star', desc: 'Reach level 5', icon: 'â­', unlocked: levelInfo.level >= 5 },
        { id: 'lvl10', name: 'Warrior', desc: 'Reach level 10', icon: 'ðŸ—¡ï¸', unlocked: levelInfo.level >= 10 },
      ];
      const unlockedCount = achievements.filter(a => a.unlocked).length;

      return (
        <div style={{ padding: '16px', paddingBottom: '90px' }}>
          <div style={{ background: 'linear-gradient(135deg, var(--card-bg), rgba(0,255,136,0.1))', borderRadius: '18px', padding: '22px', marginBottom: '18px', border: '1px solid var(--accent-color)', textAlign: 'center', position: 'relative', overflow: 'hidden' }}>
            <div style={{ position: 'absolute', top: '-50%', left: '-50%', width: '200%', height: '200%', background: 'radial-gradient(circle, var(--accent-glow) 0%, transparent 70%)', opacity: 0.3, animation: 'float 6s ease-in-out infinite' }} />
            <div style={{ fontFamily: 'Orbitron', fontSize: '54px', fontWeight: 900, color: 'var(--accent-color)', textShadow: '0 0 25px var(--accent-glow)', position: 'relative' }}>{levelInfo.level}</div>
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '2px' }}>Current Level</div>
            <div style={{ background: 'var(--main-darker)', borderRadius: '8px', height: '10px', overflow: 'hidden', marginBottom: '8px' }}>
              <div style={{ height: '100%', width: `${(levelInfo.currentXp / levelInfo.xpNeeded) * 100}%`, background: 'var(--xp-bar)', borderRadius: '8px' }} />
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', fontFamily: 'JetBrains Mono' }}>
              <span style={{ color: 'var(--accent-color)' }}>{levelInfo.currentXp} XP</span>
              <span style={{ color: 'var(--text-secondary)' }}>{levelInfo.xpNeeded} XP</span>
            </div>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', marginBottom: '20px' }}>
            {[
              { val: stats.totalXp, label: 'Total XP', color: 'var(--accent-color)' },
              { val: stats.streak, label: 'Day Streak', color: '#ffa502' },
              { val: stats.questsCompleted, label: 'Quests Done', color: 'var(--text-primary)' },
              { val: unlockedCount, label: 'Achievements', color: '#bf5fff' }
            ].map((s, i) => (
              <div key={i} style={{ background: 'var(--card-bg)', borderRadius: '10px', padding: '14px', border: '1px solid var(--border-color)', textAlign: 'center' }}>
                <div style={{ fontFamily: 'Orbitron', fontSize: '24px', fontWeight: 700, color: s.color }}>{s.val}</div>
                <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>{s.label}</div>
              </div>
            ))}
          </div>
          <h3 style={{ fontFamily: 'Orbitron', fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px', letterSpacing: '2px' }}>ACHIEVEMENTS</h3>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px' }}>
            {achievements.map(a => (
              <div key={a.id} style={{ background: a.unlocked ? 'linear-gradient(135deg, rgba(0,255,136,0.15), rgba(0,255,136,0.05))' : 'var(--card-bg)', borderRadius: '10px', padding: '12px', border: a.unlocked ? '1px solid var(--accent-color)' : '1px solid var(--border-color)', opacity: a.unlocked ? 1 : 0.5 }}>
                <div style={{ fontSize: '26px', marginBottom: '6px', filter: a.unlocked ? 'none' : 'grayscale(1)' }}>{a.icon}</div>
                <div style={{ fontSize: '12px', fontWeight: 600, marginBottom: '2px', color: a.unlocked ? 'var(--text-primary)' : 'var(--text-secondary)' }}>{a.name}</div>
                <div style={{ fontSize: '10px', color: 'var(--text-muted)' }}>{a.desc}</div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // AI Tab
    const AIAssistantTab = ({ quests, events, stats }) => {
      const [messages, setMessages] = useState([{ role: 'assistant', content: "Hello adventurer! I'm your AI companion. Ask me about quests, calendar, or stats!" }]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const messagesEndRef = useRef(null);
      useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const generateResponse = (msg) => {
        const m = msg.toLowerCase();
        const today = new Date().toISOString().split('T')[0];
        const levelInfo = calculateLevel(stats.totalXp);
        if (m.includes('quest') || m.includes('task')) {
          if (m.includes('today')) {
            const tq = quests.filter(q => isSameDay(q.date, today));
            const pending = tq.filter(q => !q.completed);
            if (pending.length === 0) return "All quests completed for today! ðŸŽ‰";
            return `${pending.length} pending quest${pending.length !== 1 ? 's' : ''}:\n${pending.map(q => `â€¢ ${q.title}`).join('\n')}`;
          }
          return `${quests.length} total quests. ${quests.filter(q => q.completed).length} done, ${quests.filter(q => !q.completed).length} pending.`;
        }
        if (m.includes('event') || m.includes('calendar')) {
          const te = events.filter(e => isSameDay(e.date, today));
          if (te.length === 0) return "No events today.";
          return `Today's events:\n${te.map(e => `â€¢ ${e.title}${e.time ? ` at ${formatTime(e.time)}` : ''}`).join('\n')}`;
        }
        if (m.includes('level') || m.includes('xp') || m.includes('stat')) {
          return `ðŸ“Š Stats:\nâ€¢ Level: ${levelInfo.level}\nâ€¢ XP: ${stats.totalXp}\nâ€¢ Quests: ${stats.questsCompleted}\nâ€¢ Streak: ${stats.streak} days`;
        }
        if (m.includes('streak')) return stats.streak === 0 ? "Start your streak by completing a quest!" : `${stats.streak} day streak! ðŸ”¥`;
        if (m.includes('help')) return "Ask about:\nâ€¢ Today's quests\nâ€¢ Calendar events\nâ€¢ Your stats\nâ€¢ Your streak";
        if (m.includes('hi') || m.includes('hello')) return `Hello! Level ${levelInfo.level} with ${quests.filter(q => !q.completed).length} quests waiting.`;
        return "Ask about your quests, calendar, or stats!";
      };

      const handleSend = async () => {
        if (!input.trim()) return;
        const userMsg = input.trim();
        setMessages(prev => [...prev, { role: 'user', content: userMsg }]);
        setInput('');
        setIsLoading(true);
        await new Promise(r => setTimeout(r, 400 + Math.random() * 400));
        setMessages(prev => [...prev, { role: 'assistant', content: generateResponse(userMsg) }]);
        setIsLoading(false);
      };

      return (
        <div style={{ display: 'flex', flexDirection: 'column', height: 'calc(100vh - 160px)', padding: '16px' }}>
          <div style={{ flex: 1, overflowY: 'auto', marginBottom: '12px' }}>
            {messages.map((msg, i) => (
              <div key={i} style={{ display: 'flex', justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start', marginBottom: '8px' }}>
                <div style={{ maxWidth: '80%', padding: '10px 14px', borderRadius: msg.role === 'user' ? '14px 14px 4px 14px' : '14px 14px 14px 4px', background: msg.role === 'user' ? 'var(--accent-color)' : 'var(--card-bg)', color: msg.role === 'user' ? 'var(--main-color)' : 'var(--text-primary)', border: msg.role === 'user' ? 'none' : '1px solid var(--border-color)', whiteSpace: 'pre-line', fontSize: '14px' }}>{msg.content}</div>
              </div>
            ))}
            {isLoading && (
              <div style={{ display: 'flex', justifyContent: 'flex-start', marginBottom: '8px' }}>
                <div style={{ padding: '10px 16px', borderRadius: '14px 14px 14px 4px', background: 'var(--card-bg)', border: '1px solid var(--border-color)' }}>
                  <div style={{ display: 'flex', gap: '4px' }}>
                    {[0, 1, 2].map(i => <div key={i} style={{ width: '6px', height: '6px', borderRadius: '50%', background: 'var(--accent-color)', animation: `float 1s ease-in-out ${i * 0.2}s infinite` }} />)}
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            <input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder="Ask about your quests..." style={{ flex: 1, background: 'var(--main-darker)', border: '1px solid var(--border-color)', borderRadius: '14px', padding: '10px 16px', color: 'var(--text-primary)', fontSize: '14px' }} />
            <button onClick={handleSend} disabled={!input.trim() || isLoading} style={{ background: 'var(--accent-color)', border: 'none', borderRadius: '14px', padding: '10px 16px', color: 'var(--main-color)', cursor: 'pointer', opacity: !input.trim() || isLoading ? 0.5 : 1 }}>
              <span style={{ width: '18px', height: '18px', display: 'block' }}><Icons.Send /></span>
            </button>
          </div>
        </div>
      );
    };

    // Settings Tab
    const SettingsTab = ({ theme, setTheme, setStats, setQuests, setEvents }) => {
      const [showReset, setShowReset] = useState(false);
      const handleThemeChange = (key) => {
        const preset = themePresets[key];
        setTheme(preset);
        document.documentElement.style.setProperty('--main-color', preset.main);
        document.documentElement.style.setProperty('--main-darker', adjustColor(preset.main, -15));
        document.documentElement.style.setProperty('--accent-color', preset.accent);
        document.documentElement.style.setProperty('--accent-glow', `${preset.accent}4d`);
      };
      const handleReset = () => { setQuests([]); setEvents([]); setStats({ totalXp: 0, questsCompleted: 0, streak: 0, todayXp: 0, lastActiveDate: null }); setShowReset(false); };

      return (
        <div style={{ padding: '16px', paddingBottom: '90px' }}>
          <h2 style={{ fontFamily: 'Orbitron', fontSize: '16px', marginBottom: '20px' }}>SETTINGS</h2>
          <div style={{ marginBottom: '20px' }}>
            <h3 style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '12px', letterSpacing: '1px' }}>THEME</h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px' }}>
              {Object.entries(themePresets).map(([key, preset]) => (
                <button key={key} onClick={() => handleThemeChange(key)} style={{ aspectRatio: '1', borderRadius: '10px', border: theme.name === preset.name ? `2px solid ${preset.accent}` : '1px solid var(--border-color)', background: preset.main, cursor: 'pointer', position: 'relative', overflow: 'hidden' }}>
                  <div style={{ position: 'absolute', bottom: 0, left: 0, right: 0, height: '30%', background: preset.accent }} />
                </button>
              ))}
            </div>
            <p style={{ textAlign: 'center', marginTop: '8px', fontSize: '12px', color: 'var(--accent-color)', fontWeight: 600 }}>{theme.name}</p>
          </div>
          <div style={{ background: 'var(--card-bg)', borderRadius: '14px', padding: '16px', marginBottom: '16px', border: '1px solid var(--border-color)' }}>
            <h3 style={{ fontSize: '14px', marginBottom: '10px' }}>ðŸ“± Siri Integration</h3>
            <p style={{ fontSize: '12px', color: 'var(--text-secondary)', lineHeight: '1.5', marginBottom: '12px' }}>Add to Home Screen to enable Siri Shortcuts.</p>
            <div style={{ background: 'var(--main-darker)', borderRadius: '8px', padding: '10px', fontSize: '11px', color: 'var(--text-muted)' }}>
              <ol style={{ paddingLeft: '16px', margin: 0 }}>
                <li style={{ marginBottom: '4px' }}>Tap Share in Safari</li>
                <li style={{ marginBottom: '4px' }}>Add to Home Screen</li>
                <li>Create Shortcuts in Shortcuts app</li>
              </ol>
            </div>
          </div>
          <div style={{ background: 'var(--card-bg)', borderRadius: '14px', padding: '16px', marginBottom: '16px', border: '1px solid var(--border-color)' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ width: '20px', height: '20px', color: '#ffa502' }}><Icons.Bell /></span>
                <span style={{ fontSize: '14px' }}>Notifications</span>
              </div>
              <button onClick={() => requestNotificationPermission()} style={{ background: 'var(--accent-color)', border: 'none', borderRadius: '6px', padding: '8px 12px', color: 'var(--main-color)', fontWeight: 600, fontSize: '11px', cursor: 'pointer' }}>Enable</button>
            </div>
          </div>
          <div style={{ background: 'var(--card-bg)', borderRadius: '14px', padding: '16px', marginBottom: '16px', border: '1px solid var(--border-color)' }}>
            <h3 style={{ fontSize: '14px', marginBottom: '12px' }}>Data</h3>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0', borderBottom: '1px solid var(--border-color)' }}>
              <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Export</span>
              <button onClick={() => { const data = { quests: JSON.parse(localStorage.getItem('questlife_quests') || '[]'), events: JSON.parse(localStorage.getItem('questlife_events') || '[]'), stats: JSON.parse(localStorage.getItem('questlife_stats') || '{}') }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'questlife_backup.json'; a.click(); }} style={{ background: 'transparent', border: '1px solid var(--border-color)', borderRadius: '6px', padding: '6px 12px', color: 'var(--text-primary)', fontSize: '11px', cursor: 'pointer' }}>Export</button>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0' }}>
              <span style={{ fontSize: '13px', color: 'var(--danger)' }}>Reset All</span>
              <button onClick={() => setShowReset(true)} style={{ background: 'transparent', border: '1px solid var(--danger)', borderRadius: '6px', padding: '6px 12px', color: 'var(--danger)', fontSize: '11px', cursor: 'pointer' }}>Reset</button>
            </div>
          </div>
          <div style={{ textAlign: 'center', padding: '16px', color: 'var(--text-muted)', fontSize: '11px' }}>
            <p style={{ fontFamily: 'Orbitron', marginBottom: '4px' }}>QUESTLIFE</p>
            <p>v1.0.0</p>
          </div>
          {showReset && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 2000, padding: '16px' }}>
              <div style={{ background: 'var(--main-color)', borderRadius: '18px', padding: '22px', maxWidth: '280px', textAlign: 'center', border: '1px solid var(--border-color)' }}>
                <div style={{ width: '44px', height: '44px', borderRadius: '50%', background: 'rgba(255,71,87,0.2)', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 12px', color: 'var(--danger)' }}><Icons.Trash /></div>
                <h3 style={{ marginBottom: '8px', fontSize: '16px' }}>Reset All Data?</h3>
                <p style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '16px' }}>This cannot be undone.</p>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button onClick={() => setShowReset(false)} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid var(--border-color)', background: 'transparent', color: 'var(--text-primary)', cursor: 'pointer' }}>Cancel</button>
                  <button onClick={handleReset} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: 'var(--danger)', color: 'white', cursor: 'pointer', fontWeight: 600 }}>Reset</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Main App
    const App = () => {
      const [activeTab, setActiveTab] = useState('quests');
      const [quests, setQuests] = useLocalStorage('questlife_quests', []);
      const [events, setEvents] = useLocalStorage('questlife_events', []);
      const [stats, setStats] = useLocalStorage('questlife_stats', { totalXp: 0, questsCompleted: 0, streak: 0, todayXp: 0, lastActiveDate: null });
      const [theme, setTheme] = useLocalStorage('questlife_theme', themePresets.default);

      useEffect(() => {
        if (theme && theme.main) {
          document.documentElement.style.setProperty('--main-color', theme.main);
          document.documentElement.style.setProperty('--main-darker', adjustColor(theme.main, -15));
          document.documentElement.style.setProperty('--accent-color', theme.accent);
          document.documentElement.style.setProperty('--accent-glow', `${theme.accent}4d`);
        }
      }, []);

      useEffect(() => {
        const today = new Date().toISOString().split('T')[0];
        if (stats.lastActiveDate) {
          const diff = Math.floor((new Date(today) - new Date(stats.lastActiveDate)) / (1000 * 60 * 60 * 24));
          if (diff > 1) setStats(prev => ({ ...prev, streak: 0, lastActiveDate: today, todayXp: 0 }));
          else if (diff === 1) setStats(prev => ({ ...prev, lastActiveDate: today, todayXp: 0 }));
        } else setStats(prev => ({ ...prev, lastActiveDate: today }));
      }, []);

      useEffect(() => {
        const today = new Date().toISOString().split('T')[0];
        const completedToday = quests.some(q => q.completed && q.completedAt && isSameDay(q.completedAt, today));
        if (completedToday && stats.lastActiveDate !== today) setStats(prev => ({ ...prev, streak: prev.streak + 1, lastActiveDate: today }));
      }, [quests]);

      return (
        <div style={{ height: '100%', display: 'flex', flexDirection: 'column', background: 'var(--main-color)' }}>
          <Header stats={stats} theme={theme} />
          <div style={{ flex: 1, overflowY: 'auto', overflowX: 'hidden' }}>
            {activeTab === 'quests' && <QuestsTab quests={quests} setQuests={setQuests} stats={stats} setStats={setStats} theme={theme} />}
            {activeTab === 'calendar' && <CalendarTab quests={quests} setQuests={setQuests} events={events} setEvents={setEvents} />}
            {activeTab === 'rewards' && <RewardsTab stats={stats} />}
            {activeTab === 'ai' && <AIAssistantTab quests={quests} events={events} stats={stats} />}
            {activeTab === 'settings' && <SettingsTab theme={theme} setTheme={setTheme} stats={stats} setStats={setStats} setQuests={setQuests} setEvents={setEvents} />}
          </div>
          <Navigation activeTab={activeTab} setActiveTab={setActiveTab} />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
