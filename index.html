<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="QuestLife">
  <meta name="theme-color" content="#1a1a1a">
  <title>QuestLife</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Exo+2:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--main:#1a1a1a;--dark:#0d0d0d;--accent:#00ff88;--glow:rgba(0,255,136,0.3);--text:#fff;--text2:#888;--text3:#555;--danger:#ff4757;--warn:#ffa502;--card:rgba(30,30,30,0.8);--border:rgba(255,255,255,0.1);--safe-t:env(safe-area-inset-top,20px);--safe-b:env(safe-area-inset-bottom,20px)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Exo 2',sans-serif;background:var(--main);color:var(--text);min-height:100vh}
    #root{height:100%}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--dark)}::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
    .anim{animation:fadeIn .3s ease-out}.pop{animation:pop .4s ease-out}
  </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useMemo,useRef}=React;

const useLS=(k,iv)=>{
  const[v,setV]=useState(()=>{
    try{
      const stored=localStorage.getItem(k);
      if(stored){return JSON.parse(stored)}
      return iv;
    }catch{return iv}
  });
  const set=val=>{
    try{
      const toStore=val instanceof Function?val(v):val;
      setV(toStore);
      localStorage.setItem(k,JSON.stringify(toStore));
    }catch(e){console.error('Storage error:',e)}
  };
  return[v,set];
};

const fmtDate=d=>new Date(d).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
const fmtTime=t=>{if(!t)return'';const[h,m]=t.split(':');const hr=parseInt(h);return`${hr%12||12}:${m} ${hr>=12?'PM':'AM'}`};

const getDateStr=(d)=>{
  if(!d)return'';
  const date=new Date(d);
  const year=date.getFullYear();
  const month=String(date.getMonth()+1).padStart(2,'0');
  const day=String(date.getDate()).padStart(2,'0');
  return`${year}-${month}-${day}`;
};

const getTodayStr=()=>{
  const now=new Date();
  const year=now.getFullYear();
  const month=String(now.getMonth()+1).padStart(2,'0');
  const day=String(now.getDate()).padStart(2,'0');
  return`${year}-${month}-${day}`;
};

const genId=()=>Math.random().toString(36).substr(2,9)+Date.now().toString(36);
const adjCol=(hex,n)=>{const num=parseInt(hex.replace('#',''),16);const r=Math.max(0,Math.min(255,(num>>16)+n));const g=Math.max(0,Math.min(255,((num>>8)&0xFF)+n));const b=Math.max(0,Math.min(255,(num&0xFF)+n));return`#${(1<<24|r<<16|g<<8|b).toString(16).slice(1)}`};
const calcLvl=xp=>{let lvl=1,need=100,tot=0;while(xp>=tot+need){tot+=need;lvl++;need=Math.floor(100*Math.pow(1.2,lvl-1))}return{level:lvl,currentXp:xp-tot,xpNeeded:need}};
const reqNotif=async()=>'Notification'in window&&(await Notification.requestPermission())==='granted';

const themes={default:{main:'#1a1a1a',accent:'#00ff88',name:'Cyber Green'},blue:{main:'#0f1729',accent:'#00d4ff',name:'Neon Blue'},purple:{main:'#1a0f29',accent:'#bf5fff',name:'Royal Purple'},red:{main:'#1f0f0f',accent:'#ff4757',name:'Crimson'},gold:{main:'#1a1507',accent:'#ffd700',name:'Golden'},pink:{main:'#1f0f1a',accent:'#ff6b9d',name:'Sakura'},orange:{main:'#1a120a',accent:'#ff9f43',name:'Sunset'},teal:{main:'#0a1a1a',accent:'#20e3b2',name:'Ocean'}};

const Icon={
  Quest:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
  Cal:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
  Trophy:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
  Gear:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>,
  AI:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/></svg>,
  Plus:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Check:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
  Clock:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  Repeat:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>,
  Bell:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
  Trash:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
  Left:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>,
  Right:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
  Send:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
  Flame:()=><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 23c-3.87 0-7-3.36-7-7.5 0-2.21.9-4.17 2.33-5.63a3.5 3.5 0 0 1 5.08 0c.28.29.71.29 1 0 1.15-1.17 1.9-2.76 2-4.5v-.75a.75.75 0 0 1 1.5 0v.75c0 .41.05.82.14 1.21C18.5 10 20 12.5 20 15.5c0 4.14-3.13 7.5-7 7.5z"/></svg>,
  X:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  Undo:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
};

const Header=({stats,theme})=>{const l=calcLvl(stats.totalXp);const p=(l.currentXp/l.xpNeeded)*100;
return<div style={{paddingTop:'calc(var(--safe-t) + 10px)',padding:'calc(var(--safe-t) + 10px) 20px 15px',background:'linear-gradient(180deg, var(--dark) 0%, transparent 100%)',position:'sticky',top:0,zIndex:100}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}>
<h1 style={{fontFamily:'Orbitron',fontSize:'22px',fontWeight:700,background:`linear-gradient(135deg, var(--accent), ${theme.accent}dd)`,WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',letterSpacing:'2px'}}>QUESTLIFE</h1>
<div style={{display:'flex',alignItems:'center',gap:'12px'}}>
<div style={{display:'flex',alignItems:'center',gap:'4px',color:'#ffa502'}}><span style={{width:'16px',height:'16px'}}><Icon.Flame/></span><span style={{fontFamily:'Orbitron',fontWeight:600,fontSize:'13px'}}>{stats.streak}</span></div>
<div style={{background:'var(--card)',padding:'6px 12px',borderRadius:'16px',border:'1px solid var(--border)',fontFamily:'Orbitron',fontSize:'11px'}}><span style={{color:'var(--accent)'}}>LVL {l.level}</span></div>
</div></div>
<div style={{background:'var(--dark)',borderRadius:'8px',height:'6px',overflow:'hidden'}}><div style={{height:'100%',width:`${p}%`,background:'linear-gradient(90deg, var(--accent), #00ffcc)',borderRadius:'8px',transition:'width 0.5s',boxShadow:'0 0 8px var(--glow)'}}/></div>
<div style={{display:'flex',justifyContent:'space-between',marginTop:'4px',fontSize:'10px',color:'var(--text2)',fontFamily:'monospace'}}><span>{l.currentXp} XP</span><span>{l.xpNeeded} XP to Level {l.level+1}</span></div>
</div>};

const Nav=({tab,setTab})=>{const tabs=[{id:'quests',icon:Icon.Quest,label:'Quests'},{id:'calendar',icon:Icon.Cal,label:'Calendar'},{id:'rewards',icon:Icon.Trophy,label:'Rewards'},{id:'ai',icon:Icon.AI,label:'AI'},{id:'settings',icon:Icon.Gear,label:'Settings'}];
return<nav style={{position:'fixed',bottom:0,left:0,right:0,background:'var(--dark)',borderTop:'1px solid var(--border)',paddingBottom:'var(--safe-b)',zIndex:1000}}>
<div style={{display:'flex',justifyContent:'space-around',padding:'8px 5px'}}>
{tabs.map(t=><button key={t.id} onClick={()=>setTab(t.id)} style={{background:'none',border:'none',display:'flex',flexDirection:'column',alignItems:'center',gap:'3px',color:tab===t.id?'var(--accent)':'var(--text2)',cursor:'pointer',padding:'5px 12px'}}>
<span style={{width:'22px',height:'22px',filter:tab===t.id?'drop-shadow(0 0 4px var(--accent))':'none'}}><t.icon/></span>
<span style={{fontSize:'9px',fontWeight:tab===t.id?600:400}}>{t.label}</span>
</button>)}
</div></nav>};

// Quest Card - now supports unchecking
const QuestCard=({quest,onToggle,onDelete})=>{
const[anim,setAnim]=useState(false);
const doToggle=()=>{setAnim(true);setTimeout(()=>{onToggle(quest.id,!quest.completed);setAnim(false)},300)};
const colors={easy:'#00ff88',medium:'#ffa502',hard:'#ff4757',epic:'#bf5fff'};
const xps={easy:10,medium:25,hard:50,epic:100};
return<div className={anim?'pop':''} style={{background:quest.completed?'linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,255,136,0.05))':'var(--card)',borderRadius:'12px',padding:'14px',marginBottom:'10px',border:`1px solid ${quest.completed?'var(--accent)':'var(--border)'}`,opacity:quest.completed?0.7:1,position:'relative',overflow:'hidden'}}>
<div style={{position:'absolute',top:0,left:0,width:'4px',height:'100%',background:colors[quest.difficulty]}}/>
<div style={{display:'flex',alignItems:'flex-start',gap:'10px',paddingLeft:'8px'}}>
<button onClick={doToggle} style={{width:'26px',height:'26px',borderRadius:'7px',border:`2px solid ${quest.completed?'var(--accent)':'var(--text2)'}`,background:quest.completed?'var(--accent)':'transparent',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',color:quest.completed?'var(--main)':'transparent',flexShrink:0}}>
{quest.completed&&<span style={{width:'14px',height:'14px'}}><Icon.Check/></span>}
</button>
<div style={{flex:1,minWidth:0}}>
<h3 style={{fontSize:'15px',fontWeight:600,marginBottom:'3px',textDecoration:quest.completed?'line-through':'none',color:quest.completed?'var(--text2)':'var(--text)'}}>{quest.title}</h3>
{quest.description&&<p style={{fontSize:'12px',color:'var(--text2)',marginBottom:'6px'}}>{quest.description}</p>}
<div style={{display:'flex',flexWrap:'wrap',gap:'6px',alignItems:'center'}}>
<span style={{background:'rgba(0,255,136,0.15)',color:'var(--accent)',padding:'2px 7px',borderRadius:'10px',fontSize:'10px',fontFamily:'Orbitron',fontWeight:600}}>+{xps[quest.difficulty]} XP</span>
{quest.isRecurring&&<span style={{display:'flex',alignItems:'center',gap:'3px',color:'var(--text2)',fontSize:'10px'}}><span style={{width:'11px',height:'11px'}}><Icon.Repeat/></span>Recurring</span>}
{quest.time&&<span style={{display:'flex',alignItems:'center',gap:'3px',color:'var(--text2)',fontSize:'10px'}}><span style={{width:'11px',height:'11px'}}><Icon.Clock/></span>{fmtTime(quest.time)}</span>}
</div></div>
<button onClick={()=>onDelete(quest.id)} style={{background:'none',border:'none',color:'var(--text3)',cursor:'pointer',padding:'4px',opacity:0.5}}>
<span style={{width:'16px',height:'16px',display:'block'}}><Icon.Trash/></span>
</button></div></div>};

// Add Quest Modal - always shows date picker, defaults to today
const AddModal=({open,onClose,onAdd,selDate})=>{
const today=getTodayStr();
const[title,setTitle]=useState('');
const[desc,setDesc]=useState('');
const[diff,setDiff]=useState('medium');
const[time,setTime]=useState('');
const[notify,setNotify]=useState(false);
const[recur,setRecur]=useState(false);
const[days,setDays]=useState([]);
const[date,setDate]=useState(selDate||today);

useEffect(()=>{
  if(open){
    // If selDate provided use it, otherwise default to today
    setDate(selDate||today);
  }
},[open,selDate,today]);

const handleClose=()=>{
  setTitle('');setDesc('');setDiff('medium');setTime('');setNotify(false);setRecur(false);setDays([]);
  onClose();
};

const submit=e=>{
  e.preventDefault();
  if(!title.trim())return;
  const q={
    id:genId(),
    title:title.trim(),
    description:desc.trim(),
    difficulty:diff,
    time:time||null,
    notify,
    isRecurring:recur,
    recurringDays:recur?days:[],
    date:date,
    completed:false,
    createdAt:new Date().toISOString()
  };
  onAdd(q);
  handleClose();
};

const dayN=['S','M','T','W','T','F','S'];
if(!open)return null;

return<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.85)',display:'flex',alignItems:'flex-end',zIndex:2000}}>
<div className="anim" style={{background:'var(--main)',width:'100%',maxHeight:'85vh',borderRadius:'20px 20px 0 0',padding:'20px',paddingBottom:'calc(20px + var(--safe-b))',overflowY:'auto',position:'relative'}}>

<button onClick={handleClose} style={{position:'absolute',top:'16px',right:'16px',background:'var(--card)',border:'1px solid var(--border)',borderRadius:'50%',width:'36px',height:'36px',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',color:'var(--text2)',zIndex:10}}>
<span style={{width:'20px',height:'20px'}}><Icon.X/></span>
</button>

<div style={{width:'40px',height:'4px',background:'var(--text3)',borderRadius:'2px',margin:'0 auto 16px'}}/>
<h2 style={{fontFamily:'Orbitron',fontSize:'18px',marginBottom:'18px',textAlign:'center'}}>NEW QUEST</h2>
<form onSubmit={submit}>
<div style={{marginBottom:'14px'}}><label style={{fontSize:'11px',color:'var(--text2)',display:'block',marginBottom:'4px'}}>Title *</label>
<input type="text" value={title} onChange={e=>setTitle(e.target.value)} placeholder="Quest name..." style={{width:'100%',background:'var(--dark)',border:'1px solid var(--border)',borderRadius:'10px',padding:'11px 14px',color:'var(--text)',fontSize:'15px'}} autoFocus/></div>
<div style={{marginBottom:'14px'}}><label style={{fontSize:'11px',color:'var(--text2)',display:'block',marginBottom:'4px'}}>Description</label>
<textarea value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Details..." rows={2} style={{width:'100%',background:'var(--dark)',border:'1px solid var(--border)',borderRadius:'10px',padding:'11px 14px',color:'var(--text)',fontSize:'13px',resize:'none'}}/></div>

{/* Date picker - always visible, defaults to today */}
<div style={{marginBottom:'14px'}}><label style={{fontSize:'11px',color:'var(--text2)',display:'block',marginBottom:'4px'}}>Date</label>
<input type="date" value={date} onChange={e=>setDate(e.target.value)} style={{width:'100%',background:'var(--dark)',border:'1px solid var(--border)',borderRadius:'10px',padding:'11px 14px',color:'var(--text)',fontSize:'15px'}}/></div>

<div style={{marginBottom:'14px'}}><label style={{fontSize:'11px',color:'var(--text2)',display:'block',marginBottom:'4px'}}>Difficulty</label>
<div style={{display:'flex',gap:'8px'}}>{['easy','medium','hard','epic'].map(d=><button key={d} type="button" onClick={()=>setDiff(d)} style={{flex:1,padding:'9px',borderRadius:'8px',border:diff===d?'2px solid var(--accent)':'1px solid var(--border)',background:diff===d?'rgba(0,255,136,0.1)':'var(--dark)',color:diff===d?'var(--accent)':'var(--text2)',fontSize:'11px',fontWeight:600,textTransform:'capitalize',cursor:'pointer'}}>{d}</button>)}</div></div>
<div style={{marginBottom:'14px'}}><label style={{fontSize:'11px',color:'var(--text2)',display:'block',marginBottom:'4px'}}>Time</label>
<input type="time" value={time} onChange={e=>setTime(e.target.value)} style={{width:'100%',background:'var(--dark)',border:'1px solid var(--border)',borderRadius:'10px',padding:'11px 14px',color:'var(--text)',fontSize:'15px'}}/></div>
<div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'14px',padding:'11px 14px',background:'var(--dark)',borderRadius:'10px'}}>
<div style={{display:'flex',alignItems:'center',gap:'8px'}}><span style={{width:'18px',height:'18px',color:'var(--text2)'}}><Icon.Bell/></span><span style={{fontSize:'13px'}}>Notification</span></div>
<button type="button" onClick={()=>{if(!notify)reqNotif();setNotify(!notify)}} style={{width:'46px',height:'26px',borderRadius:'13px',border:'none',background:notify?'var(--accent)':'var(--text3)',cursor:'pointer',position:'relative'}}><div style={{width:'20px',height:'20px',borderRadius:'50%',background:'white',position:'absolute',top:'3px',left:notify?'23px':'3px',transition:'left 0.2s'}}/></button></div>
<div style={{marginBottom:'14px',padding:'11px 14px',background:'var(--dark)',borderRadius:'10px'}}>
<div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:recur?'12px':0}}>
<div style={{display:'flex',alignItems:'center',gap:'8px'}}><span style={{width:'18px',height:'18px',color:'var(--text2)'}}><Icon.Repeat/></span><span style={{fontSize:'13px'}}>Recurring</span></div>
<button type="button" onClick={()=>setRecur(!recur)} style={{width:'46px',height:'26px',borderRadius:'13px',border:'none',background:recur?'var(--accent)':'var(--text3)',cursor:'pointer',position:'relative'}}><div style={{width:'20px',height:'20px',borderRadius:'50%',background:'white',position:'absolute',top:'3px',left:recur?'23px':'3px',transition:'left 0.2s'}}/></button></div>
{recur&&<div style={{display:'flex',gap:'4px'}}>{dayN.map((d,i)=><button key={i} type="button" onClick={()=>setDays(p=>p.includes(i)?p.filter(x=>x!==i):[...p,i])} style={{flex:1,padding:'7px 4px',borderRadius:'6px',border:days.includes(i)?'1px solid var(--accent)':'1px solid var(--border)',background:days.includes(i)?'rgba(0,255,136,0.2)':'transparent',color:days.includes(i)?'var(--accent)':'var(--text2)',fontSize:'10px',cursor:'pointer'}}>{d}</button>)}</div>}</div>
<button type="submit" style={{width:'100%',padding:'14px',borderRadius:'12px',border:'none',background:'var(--accent)',color:'var(--main)',fontSize:'15px',fontFamily:'Orbitron',fontWeight:700,cursor:'pointer',boxShadow:'0 0 15px var(--glow)'}}>CREATE QUEST</button>
</form></div></div>};

// Quests Tab - shows today's quests, can add future quests
const QuestsTab=({quests,setQuests,stats,setStats,theme})=>{
const[modal,setModal]=useState(false);
const today=getTodayStr();
const todayDow=new Date().getDay();

// Filter quests for TODAY only
const todayQuests=useMemo(()=>{
  return quests.filter(q=>{
    const questDateMatches=q.date===today;
    const recurringToday=q.isRecurring&&q.recurringDays&&q.recurringDays.includes(todayDow);
    return questDateMatches||recurringToday;
  });
},[quests,today,todayDow]);

// Toggle quest completion (check or uncheck)
const toggleQuest=(id,completed)=>{
  const q=quests.find(x=>x.id===id);
  if(!q)return;
  const xp={easy:10,medium:25,hard:50,epic:100}[q.difficulty];
  
  if(completed&&!q.completed){
    // Marking as complete - add XP
    setQuests(p=>p.map(x=>x.id===id?{...x,completed:true,completedAt:new Date().toISOString()}:x));
    setStats(p=>({...p,totalXp:p.totalXp+xp,questsCompleted:p.questsCompleted+1}));
  }else if(!completed&&q.completed){
    // Unmarking as complete - remove XP
    setQuests(p=>p.map(x=>x.id===id?{...x,completed:false,completedAt:null}:x));
    setStats(p=>({...p,totalXp:Math.max(0,p.totalXp-xp),questsCompleted:Math.max(0,p.questsCompleted-1)}));
  }
};

const pending=todayQuests.filter(q=>!q.completed);
const done=todayQuests.filter(q=>q.completed);

return<div style={{padding:'16px',paddingBottom:'90px'}}>
<div style={{background:'var(--card)',borderRadius:'14px',padding:'16px',marginBottom:'16px',border:'1px solid var(--border)'}}>
<div style={{display:'flex',justifyContent:'space-between',marginBottom:'8px'}}><span style={{color:'var(--text2)',fontSize:'12px'}}>Today's Progress</span><span style={{color:'var(--accent)',fontFamily:'Orbitron',fontSize:'13px'}}>{done.length}/{todayQuests.length}</span></div>
<div style={{background:'var(--dark)',borderRadius:'6px',height:'8px',overflow:'hidden'}}><div style={{height:'100%',width:todayQuests.length>0?`${(done.length/todayQuests.length)*100}%`:'0%',background:'linear-gradient(90deg, var(--accent), #00ffcc)',borderRadius:'6px'}}/></div></div>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}>
<h2 style={{fontFamily:'Orbitron',fontSize:'12px',color:'var(--text2)',letterSpacing:'2px'}}>{fmtDate(today).toUpperCase()}</h2>
<button onClick={()=>setModal(true)} style={{background:'var(--accent)',border:'none',borderRadius:'10px',padding:'9px 14px',color:'var(--main)',fontWeight:600,fontSize:'12px',cursor:'pointer',display:'flex',alignItems:'center',gap:'4px',boxShadow:'0 0 12px var(--glow)'}}><span style={{width:'14px',height:'14px'}}><Icon.Plus/></span>New Quest</button></div>
{pending.length===0&&done.length===0?<div style={{textAlign:'center',padding:'36px 16px',color:'var(--text2)'}}><div style={{width:'50px',height:'50px',margin:'0 auto 12px',opacity:0.3}}><Icon.Quest/></div><p style={{fontSize:'15px',marginBottom:'4px'}}>No quests today</p><p style={{fontSize:'12px',color:'var(--text3)'}}>Create your first quest!</p></div>:
<>{pending.map(q=><QuestCard key={q.id} quest={q} onToggle={toggleQuest} onDelete={id=>setQuests(p=>p.filter(x=>x.id!==id))}/>)}
{done.length>0&&<><div style={{fontSize:'11px',color:'var(--text3)',margin:'16px 0 8px',display:'flex',alignItems:'center',gap:'8px'}}><span>COMPLETED</span><div style={{flex:1,height:'1px',background:'var(--border)'}}/></div>
{done.map(q=><QuestCard key={q.id} quest={q} onToggle={toggleQuest} onDelete={id=>setQuests(p=>p.filter(x=>x.id!==id))}/>)}</>}</>}

{/* Date picker defaults to today but can be changed */}
<AddModal open={modal} onClose={()=>setModal(false)} onAdd={q=>setQuests(p=>[...p,q])} selDate={today}/></div>};

// Calendar Tab
const CalTab=({quests,setQuests,events,setEvents})=>{
const[cur,setCur]=useState(new Date());
const[sel,setSel]=useState(null);
const[modal,setModal]=useState(false);
const[evtModal,setEvtModal]=useState(false);
const[newEvt,setNewEvt]=useState({title:'',time:''});
const today=getTodayStr();

const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
const getDays=d=>{const y=d.getFullYear(),m=d.getMonth();const f=new Date(y,m,1),l=new Date(y,m+1,0);const days=[];for(let i=0;i<f.getDay();i++)days.push(null);for(let i=1;i<=l.getDate();i++)days.push(new Date(y,m,i));return days};
const days=getDays(cur);

const getQ=d=>{
  if(!d)return[];
  const ds=getDateStr(d);
  const dow=d.getDay();
  return quests.filter(q=>{
    const dateMatch=q.date===ds;
    const recurMatch=q.isRecurring&&q.recurringDays&&q.recurringDays.includes(dow);
    return dateMatch||recurMatch;
  });
};

const getE=d=>{if(!d)return[];const ds=getDateStr(d);return events.filter(e=>e.date===ds)};
const selQ=sel?getQ(new Date(sel)):[];
const selE=sel?getE(new Date(sel)):[];

// Toggle for calendar view too
const toggleQuest=(id,completed)=>{
  const q=quests.find(x=>x.id===id);
  if(!q)return;
  if(completed&&!q.completed){
    setQuests(p=>p.map(x=>x.id===id?{...x,completed:true,completedAt:new Date().toISOString()}:x));
  }else if(!completed&&q.completed){
    setQuests(p=>p.map(x=>x.id===id?{...x,completed:false,completedAt:null}:x));
  }
};

const addEvt=()=>{if(!newEvt.title.trim())return;setEvents(p=>[...p,{id:genId(),...newEvt,date:sel}]);setNewEvt({title:'',time:''});setEvtModal(false)};

return<div style={{padding:'16px',paddingBottom:'90px'}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
<button onClick={()=>setCur(new Date(cur.getFullYear(),cur.getMonth()-1))} style={{background:'var(--card)',border:'1px solid var(--border)',borderRadius:'8px',padding:'8px',color:'var(--text)',cursor:'pointer'}}><span style={{width:'18px',height:'18px',display:'block'}}><Icon.Left/></span></button>
<h2 style={{fontFamily:'Orbitron',fontSize:'16px'}}>{months[cur.getMonth()]} {cur.getFullYear()}</h2>
<button onClick={()=>setCur(new Date(cur.getFullYear(),cur.getMonth()+1))} style={{background:'var(--card)',border:'1px solid var(--border)',borderRadius:'8px',padding:'8px',color:'var(--text)',cursor:'pointer'}}><span style={{width:'18px',height:'18px',display:'block'}}><Icon.Right/></span></button></div>
<div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:'4px',marginBottom:'8px'}}>{['S','M','T','W','T','F','S'].map((d,i)=><div key={i} style={{textAlign:'center',fontSize:'11px',color:'var(--text2)',fontWeight:600,padding:'4px'}}>{d}</div>)}</div>
<div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:'4px'}}>
{days.map((d,i)=>{if(!d)return<div key={i}/>;const ds=getDateStr(d);const dq=getQ(d);const de=getE(d);const isT=ds===today;const isS=sel===ds;const has=dq.length>0||de.length>0;
return<button key={i} onClick={()=>setSel(ds)} style={{aspectRatio:'1',background:isS?'var(--accent)':isT?'rgba(0,255,136,0.2)':'var(--card)',border:isT?'2px solid var(--accent)':'1px solid var(--border)',borderRadius:'8px',color:isS?'var(--main)':'var(--text)',fontWeight:isT?700:400,fontSize:'13px',cursor:'pointer',position:'relative',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center'}}>
{d.getDate()}{has&&<div style={{position:'absolute',bottom:'3px',display:'flex',gap:'2px'}}>{dq.length>0&&<div style={{width:'4px',height:'4px',borderRadius:'50%',background:isS?'var(--main)':'var(--accent)'}}/>}{de.length>0&&<div style={{width:'4px',height:'4px',borderRadius:'50%',background:isS?'var(--main)':'#ffa502'}}/>}</div>}
</button>})}</div>
{sel&&<div style={{marginTop:'16px'}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}>
<h3 style={{fontFamily:'Orbitron',fontSize:'12px',color:'var(--text2)'}}>{fmtDate(sel).toUpperCase()}</h3>
<div style={{display:'flex',gap:'8px'}}><button onClick={()=>setModal(true)} style={{background:'var(--accent)',border:'none',borderRadius:'6px',padding:'6px 10px',color:'var(--main)',fontWeight:600,fontSize:'11px',cursor:'pointer'}}>+ Quest</button>
<button onClick={()=>setEvtModal(true)} style={{background:'#ffa502',border:'none',borderRadius:'6px',padding:'6px 10px',color:'var(--main)',fontWeight:600,fontSize:'11px',cursor:'pointer'}}>+ Event</button></div></div>
{selQ.length===0&&selE.length===0?<div style={{textAlign:'center',padding:'24px',color:'var(--text2)',background:'var(--card)',borderRadius:'10px',border:'1px solid var(--border)'}}><p style={{fontSize:'13px'}}>No items</p></div>:
<>{selE.map(e=><div key={e.id} style={{background:'var(--card)',borderRadius:'10px',padding:'12px',marginBottom:'8px',border:'1px solid var(--border)',borderLeft:'4px solid #ffa502'}}><div style={{display:'flex',justifyContent:'space-between'}}><div><h4 style={{fontSize:'14px',marginBottom:'3px'}}>{e.title}</h4>{e.time&&<span style={{fontSize:'11px',color:'var(--text2)'}}>{fmtTime(e.time)}</span>}</div>
<button onClick={()=>setEvents(p=>p.filter(x=>x.id!==e.id))} style={{background:'none',border:'none',color:'var(--text3)',cursor:'pointer',padding:'3px'}}><span style={{width:'14px',height:'14px',display:'block'}}><Icon.Trash/></span></button></div></div>)}
{selQ.map(q=><QuestCard key={q.id} quest={q} onToggle={toggleQuest} onDelete={id=>setQuests(p=>p.filter(x=>x.id!==id))}/>)}</>}</div>}

<AddModal open={modal} onClose={()=>setModal(false)} onAdd={q=>setQuests(p=>[...p,q])} selDate={sel}/>

{evtModal&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.85)',display:'flex',alignItems:'flex-end',zIndex:2000}}>
<div className="anim" style={{background:'var(--main)',width:'100%',borderRadius:'20px 20px 0 0',padding:'20px',paddingBottom:'calc(20px + var(--safe-b))',position:'relative'}}>
<button onClick={()=>{setEvtModal(false);setNewEvt({title:'',time:''})}} style={{position:'absolute',top:'16px',right:'16px',background:'var(--card)',border:'1px solid var(--border)',borderRadius:'50%',width:'36px',height:'36px',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',color:'var(--text2)'}}><span style={{width:'20px',height:'20px'}}><Icon.X/></span></button>
<div style={{width:'40px',height:'4px',background:'var(--text3)',borderRadius:'2px',margin:'0 auto 16px'}}/>
<h2 style={{fontFamily:'Orbitron',fontSize:'18px',marginBottom:'18px',textAlign:'center'}}>NEW EVENT</h2>
<input type="text" placeholder="Event title" value={newEvt.title} onChange={e=>setNewEvt(p=>({...p,title:e.target.value}))} style={{width:'100%',background:'var(--dark)',border:'1px solid var(--border)',borderRadius:'10px',padding:'11px 14px',color:'var(--text)',fontSize:'15px',marginBottom:'12px'}} autoFocus/>
<input type="time" value={newEvt.time} onChange={e=>setNewEvt(p=>({...p,time:e.target.value}))} style={{width:'100%',background:'var(--dark)',border:'1px solid var(--border)',borderRadius:'10px',padding:'11px 14px',color:'var(--text)',fontSize:'15px',marginBottom:'12px'}}/>
<button onClick={addEvt} style={{width:'100%',padding:'14px',borderRadius:'12px',border:'none',background:'#ffa502',color:'var(--main)',fontSize:'15px',fontFamily:'Orbitron',fontWeight:700,cursor:'pointer'}}>CREATE EVENT</button>
</div></div>}</div>};

const RewardsTab=({stats})=>{const l=calcLvl(stats.totalXp);
const achs=[{id:'first',name:'First Steps',desc:'Complete first quest',icon:'âš”ï¸',ok:stats.questsCompleted>=1},{id:'ten',name:'Adventurer',desc:'Complete 10 quests',icon:'ðŸ†',ok:stats.questsCompleted>=10},{id:'fifty',name:'Hero',desc:'Complete 50 quests',icon:'ðŸ‘‘',ok:stats.questsCompleted>=50},{id:'week',name:'Consistent',desc:'7 day streak',icon:'ðŸ”¥',ok:stats.streak>=7},{id:'month',name:'Dedicated',desc:'30 day streak',icon:'ðŸ’Ž',ok:stats.streak>=30},{id:'lvl5',name:'Rising Star',desc:'Reach level 5',icon:'â­',ok:l.level>=5},{id:'lvl10',name:'Warrior',desc:'Reach level 10',icon:'ðŸ—¡ï¸',ok:l.level>=10},{id:'lvl25',name:'Champion',desc:'Reach level 25',icon:'ðŸ›¡ï¸',ok:l.level>=25}];
const unlocked=achs.filter(a=>a.ok).length;
return<div style={{padding:'16px',paddingBottom:'90px'}}>
<div style={{background:'linear-gradient(135deg, var(--card), rgba(0,255,136,0.1))',borderRadius:'18px',padding:'22px',marginBottom:'18px',border:'1px solid var(--accent)',textAlign:'center',position:'relative',overflow:'hidden'}}>
<div style={{position:'absolute',top:'-50%',left:'-50%',width:'200%',height:'200%',background:'radial-gradient(circle, var(--glow) 0%, transparent 70%)',opacity:0.3,animation:'float 6s ease-in-out infinite'}}/>
<div style={{fontFamily:'Orbitron',fontSize:'54px',fontWeight:900,color:'var(--accent)',textShadow:'0 0 25px var(--glow)',position:'relative'}}>{l.level}</div>
<div style={{fontSize:'12px',color:'var(--text2)',marginBottom:'12px',textTransform:'uppercase',letterSpacing:'2px'}}>Current Level</div>
<div style={{background:'var(--dark)',borderRadius:'8px',height:'10px',overflow:'hidden',marginBottom:'8px'}}><div style={{height:'100%',width:`${(l.currentXp/l.xpNeeded)*100}%`,background:'linear-gradient(90deg, var(--accent), #00ffcc)',borderRadius:'8px'}}/></div>
<div style={{display:'flex',justifyContent:'space-between',fontSize:'11px',fontFamily:'monospace'}}><span style={{color:'var(--accent)'}}>{l.currentXp} XP</span><span style={{color:'var(--text2)'}}>{l.xpNeeded} XP</span></div></div>
<div style={{display:'grid',gridTemplateColumns:'repeat(2, 1fr)',gap:'8px',marginBottom:'20px'}}>
{[{v:stats.totalXp,l:'Total XP',c:'var(--accent)'},{v:stats.streak,l:'Day Streak',c:'#ffa502'},{v:stats.questsCompleted,l:'Quests Done',c:'var(--text)'},{v:unlocked,l:'Achievements',c:'#bf5fff'}].map((s,i)=>
<div key={i} style={{background:'var(--card)',borderRadius:'10px',padding:'14px',border:'1px solid var(--border)',textAlign:'center'}}><div style={{fontFamily:'Orbitron',fontSize:'24px',fontWeight:700,color:s.c}}>{s.v}</div><div style={{fontSize:'11px',color:'var(--text2)'}}>{s.l}</div></div>)}</div>
<h3 style={{fontFamily:'Orbitron',fontSize:'12px',color:'var(--text2)',marginBottom:'12px',letterSpacing:'2px'}}>ACHIEVEMENTS</h3>
<div style={{display:'grid',gridTemplateColumns:'repeat(2, 1fr)',gap:'8px'}}>
{achs.map(a=><div key={a.id} style={{background:a.ok?'linear-gradient(135deg, rgba(0,255,136,0.15), rgba(0,255,136,0.05))':'var(--card)',borderRadius:'10px',padding:'12px',border:a.ok?'1px solid var(--accent)':'1px solid var(--border)',opacity:a.ok?1:0.5}}>
<div style={{fontSize:'26px',marginBottom:'6px',filter:a.ok?'none':'grayscale(1)'}}>{a.icon}</div>
<div style={{fontSize:'12px',fontWeight:600,marginBottom:'2px',color:a.ok?'var(--text)':'var(--text2)'}}>{a.name}</div>
<div style={{fontSize:'10px',color:'var(--text3)'}}>{a.desc}</div></div>)}</div></div>};

const AITab=({quests,events,stats})=>{const[msgs,setMsgs]=useState([{role:'ai',text:"Hello adventurer! Ask about quests, calendar, or stats!"}]);const[inp,setInp]=useState('');const[loading,setLoading]=useState(false);const endRef=useRef(null);
useEffect(()=>{endRef.current?.scrollIntoView({behavior:'smooth'})},[msgs]);
const respond=m=>{const x=m.toLowerCase();const today=getTodayStr();const l=calcLvl(stats.totalXp);
if(x.includes('quest')||x.includes('task')){if(x.includes('today')){const tq=quests.filter(q=>q.date===today);const p=tq.filter(q=>!q.completed);if(p.length===0)return"All done today! ðŸŽ‰";return`${p.length} pending:\n${p.map(q=>`â€¢ ${q.title}`).join('\n')}`}return`${quests.length} total. ${quests.filter(q=>q.completed).length} done.`}
if(x.includes('event')||x.includes('calendar')){const te=events.filter(e=>e.date===today);if(te.length===0)return"No events today.";return`Today:\n${te.map(e=>`â€¢ ${e.title}${e.time?` at ${fmtTime(e.time)}`:''}`).join('\n')}`}
if(x.includes('level')||x.includes('xp')||x.includes('stat'))return`ðŸ“Š Level: ${l.level}\nâ€¢ XP: ${stats.totalXp}\nâ€¢ Quests: ${stats.questsCompleted}\nâ€¢ Streak: ${stats.streak} days`;
if(x.includes('streak'))return stats.streak===0?"Start by completing a quest!":`${stats.streak} day streak! ðŸ”¥`;
if(x.includes('help'))return"Ask about:\nâ€¢ Today's quests\nâ€¢ Events\nâ€¢ Stats\nâ€¢ Streak";
if(x.includes('hi')||x.includes('hello'))return`Hello! Level ${l.level} with ${quests.filter(q=>!q.completed).length} quests waiting.`;
return"Ask about quests, calendar, or stats!"};
const send=async()=>{if(!inp.trim())return;const m=inp.trim();setMsgs(p=>[...p,{role:'user',text:m}]);setInp('');setLoading(true);await new Promise(r=>setTimeout(r,400+Math.random()*400));setMsgs(p=>[...p,{role:'ai',text:respond(m)}]);setLoading(false)};
return<div style={{display:'flex',flexDirection:'column',height:'calc(100vh - 160px)',padding:'16px'}}>
<div style={{flex:1,overflowY:'auto',marginBottom:'12px'}}>
{msgs.map((m,i)=><div key={i} style={{display:'flex',justifyContent:m.role==='user'?'flex-end':'flex-start',marginBottom:'8px'}}>
<div style={{maxWidth:'80%',padding:'10px 14px',borderRadius:m.role==='user'?'14px 14px 4px 14px':'14px 14px 14px 4px',background:m.role==='user'?'var(--accent)':'var(--card)',color:m.role==='user'?'var(--main)':'var(--text)',border:m.role==='user'?'none':'1px solid var(--border)',whiteSpace:'pre-line',fontSize:'14px'}}>{m.text}</div></div>)}
{loading&&<div style={{display:'flex',justifyContent:'flex-start',marginBottom:'8px'}}><div style={{padding:'10px 16px',borderRadius:'14px 14px 14px 4px',background:'var(--card)',border:'1px solid var(--border)'}}><div style={{display:'flex',gap:'4px'}}>{[0,1,2].map(i=><div key={i} style={{width:'6px',height:'6px',borderRadius:'50%',background:'var(--accent)',animation:`float 1s ease-in-out ${i*0.2}s infinite`}}/>)}</div></div></div>}
<div ref={endRef}/></div>
<div style={{display:'flex',gap:'8px'}}>
<input type="text" value={inp} onChange={e=>setInp(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="Ask..." style={{flex:1,background:'var(--dark)',border:'1px solid var(--border)',borderRadius:'14px',padding:'10px 16px',color:'var(--text)',fontSize:'14px'}}/>
<button onClick={send} disabled={!inp.trim()||loading} style={{background:'var(--accent)',border:'none',borderRadius:'14px',padding:'10px 16px',color:'var(--main)',cursor:'pointer',opacity:!inp.trim()||loading?0.5:1}}><span style={{width:'18px',height:'18px',display:'block'}}><Icon.Send/></span></button></div></div>};

const SettingsTab=({theme,setTheme,setStats,setQuests,setEvents})=>{const[showReset,setShowReset]=useState(false);
const setT=k=>{const p=themes[k];setTheme(p);document.documentElement.style.setProperty('--main',p.main);document.documentElement.style.setProperty('--dark',adjCol(p.main,-15));document.documentElement.style.setProperty('--accent',p.accent);document.documentElement.style.setProperty('--glow',`${p.accent}4d`)};
const reset=()=>{setQuests([]);setEvents([]);setStats({totalXp:0,questsCompleted:0,streak:0,todayXp:0,lastActiveDate:null});setShowReset(false)};
return<div style={{padding:'16px',paddingBottom:'90px'}}>
<h2 style={{fontFamily:'Orbitron',fontSize:'16px',marginBottom:'20px'}}>SETTINGS</h2>
<div style={{marginBottom:'20px'}}><h3 style={{fontSize:'11px',color:'var(--text2)',marginBottom:'12px',letterSpacing:'1px'}}>THEME</h3>
<div style={{display:'grid',gridTemplateColumns:'repeat(4, 1fr)',gap:'8px'}}>
{Object.entries(themes).map(([k,p])=><button key={k} onClick={()=>setT(k)} style={{aspectRatio:'1',borderRadius:'10px',border:theme.name===p.name?`2px solid ${p.accent}`:'1px solid var(--border)',background:p.main,cursor:'pointer',position:'relative',overflow:'hidden'}}><div style={{position:'absolute',bottom:0,left:0,right:0,height:'30%',background:p.accent}}/></button>)}</div>
<p style={{textAlign:'center',marginTop:'8px',fontSize:'12px',color:'var(--accent)',fontWeight:600}}>{theme.name}</p></div>
<div style={{background:'var(--card)',borderRadius:'14px',padding:'16px',marginBottom:'16px',border:'1px solid var(--border)'}}>
<h3 style={{fontSize:'14px',marginBottom:'10px'}}>ðŸ’¾ Data Storage</h3>
<p style={{fontSize:'12px',color:'var(--text2)',lineHeight:'1.5'}}>Your quests and progress are automatically saved on this device. No account needed!</p></div>
<div style={{background:'var(--card)',borderRadius:'14px',padding:'16px',marginBottom:'16px',border:'1px solid var(--border)'}}>
<h3 style={{fontSize:'14px',marginBottom:'10px'}}>ðŸ“± Siri Integration</h3>
<p style={{fontSize:'12px',color:'var(--text2)',lineHeight:'1.5',marginBottom:'12px'}}>Add to Home Screen to enable Siri Shortcuts.</p>
<div style={{background:'var(--dark)',borderRadius:'8px',padding:'10px',fontSize:'11px',color:'var(--text3)'}}>
<ol style={{paddingLeft:'16px',margin:0}}><li style={{marginBottom:'4px'}}>Tap Share in Safari</li><li style={{marginBottom:'4px'}}>Add to Home Screen</li><li>Create Shortcuts in Shortcuts app</li></ol></div></div>
<div style={{background:'var(--card)',borderRadius:'14px',padding:'16px',marginBottom:'16px',border:'1px solid var(--border)'}}>
<div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
<div style={{display:'flex',alignItems:'center',gap:'10px'}}><span style={{width:'20px',height:'20px',color:'#ffa502'}}><Icon.Bell/></span><span style={{fontSize:'14px'}}>Notifications</span></div>
<button onClick={()=>reqNotif()} style={{background:'var(--accent)',border:'none',borderRadius:'6px',padding:'8px 12px',color:'var(--main)',fontWeight:600,fontSize:'11px',cursor:'pointer'}}>Enable</button></div></div>
<div style={{background:'var(--card)',borderRadius:'14px',padding:'16px',marginBottom:'16px',border:'1px solid var(--border)'}}>
<h3 style={{fontSize:'14px',marginBottom:'12px'}}>Data</h3>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0',borderBottom:'1px solid var(--border)'}}>
<span style={{fontSize:'13px',color:'var(--text2)'}}>Export</span>
<button onClick={()=>{const d={quests:JSON.parse(localStorage.getItem('ql_quests')||'[]'),events:JSON.parse(localStorage.getItem('ql_events')||'[]'),stats:JSON.parse(localStorage.getItem('ql_stats')||'{}')};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='questlife.json';a.click()}} style={{background:'transparent',border:'1px solid var(--border)',borderRadius:'6px',padding:'6px 12px',color:'var(--text)',fontSize:'11px',cursor:'pointer'}}>Export</button></div>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 0'}}>
<span style={{fontSize:'13px',color:'var(--danger)'}}>Reset All</span>
<button onClick={()=>setShowReset(true)} style={{background:'transparent',border:'1px solid var(--danger)',borderRadius:'6px',padding:'6px 12px',color:'var(--danger)',fontSize:'11px',cursor:'pointer'}}>Reset</button></div></div>
<div style={{textAlign:'center',padding:'16px',color:'var(--text3)',fontSize:'11px'}}><p style={{fontFamily:'Orbitron',marginBottom:'4px'}}>QUESTLIFE</p><p>v1.2.0</p></div>
{showReset&&<div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.85)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2000,padding:'16px'}}>
<div style={{background:'var(--main)',borderRadius:'18px',padding:'22px',maxWidth:'280px',textAlign:'center',border:'1px solid var(--border)'}}>
<div style={{width:'44px',height:'44px',borderRadius:'50%',background:'rgba(255,71,87,0.2)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 12px',color:'var(--danger)'}}><Icon.Trash/></div>
<h3 style={{marginBottom:'8px',fontSize:'16px'}}>Reset All Data?</h3>
<p style={{fontSize:'12px',color:'var(--text2)',marginBottom:'16px'}}>This cannot be undone.</p>
<div style={{display:'flex',gap:'8px'}}><button onClick={()=>setShowReset(false)} style={{flex:1,padding:'10px',borderRadius:'8px',border:'1px solid var(--border)',background:'transparent',color:'var(--text)',cursor:'pointer'}}>Cancel</button>
<button onClick={reset} style={{flex:1,padding:'10px',borderRadius:'8px',border:'none',background:'var(--danger)',color:'white',cursor:'pointer',fontWeight:600}}>Reset</button></div></div></div>}</div>};

const App=()=>{
const[tab,setTab]=useState('quests');
const[quests,setQuests]=useLS('ql_quests',[]);
const[events,setEvents]=useLS('ql_events',[]);
const[stats,setStats]=useLS('ql_stats',{totalXp:0,questsCompleted:0,streak:0,todayXp:0,lastActiveDate:null});
const[theme,setTheme]=useLS('ql_theme',themes.default);

useEffect(()=>{
  if(theme&&theme.main){
    document.documentElement.style.setProperty('--main',theme.main);
    document.documentElement.style.setProperty('--dark',adjCol(theme.main,-15));
    document.documentElement.style.setProperty('--accent',theme.accent);
    document.documentElement.style.setProperty('--glow',`${theme.accent}4d`);
  }
},[]);

useEffect(()=>{
  const today=getTodayStr();
  if(stats.lastActiveDate){
    const lastDate=new Date(stats.lastActiveDate);
    const todayDate=new Date(today);
    const diffTime=todayDate.getTime()-lastDate.getTime();
    const diffDays=Math.floor(diffTime/(1000*60*60*24));
    if(diffDays>1){
      setStats(p=>({...p,streak:0,lastActiveDate:today,todayXp:0}));
    }else if(diffDays===1){
      setStats(p=>({...p,lastActiveDate:today,todayXp:0}));
    }
  }else{
    setStats(p=>({...p,lastActiveDate:today}));
  }
},[]);

useEffect(()=>{
  const today=getTodayStr();
  const doneToday=quests.some(q=>q.completed&&q.completedAt&&getDateStr(q.completedAt)===today);
  if(doneToday&&stats.lastActiveDate!==today){
    setStats(p=>({...p,streak:p.streak+1,lastActiveDate:today}));
  }
},[quests]);

return<div style={{height:'100%',display:'flex',flexDirection:'column',background:'var(--main)'}}>
<Header stats={stats} theme={theme}/>
<div style={{flex:1,overflowY:'auto',overflowX:'hidden'}}>
{tab==='quests'&&<QuestsTab quests={quests} setQuests={setQuests} stats={stats} setStats={setStats} theme={theme}/>}
{tab==='calendar'&&<CalTab quests={quests} setQuests={setQuests} events={events} setEvents={setEvents}/>}
{tab==='rewards'&&<RewardsTab stats={stats}/>}
{tab==='ai'&&<AITab quests={quests} events={events} stats={stats}/>}
{tab==='settings'&&<SettingsTab theme={theme} setTheme={setTheme} stats={stats} setStats={setStats} setQuests={setQuests} setEvents={setEvents}/>}
</div>
<Nav tab={tab} setTab={setTab}/>
</div>};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
